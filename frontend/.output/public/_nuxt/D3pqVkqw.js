import{n as N,C as M,D as E,E as F,G as q,H,x as B,I,J as z,K as J,L as Q,z as w,M as W,N as X,O as Y,P as Z,i as K,j,k,c as p,F as A,B as ee,o as C,a as b,t as S,q as O,d as ae,l as te,b as se,v as re,Q as ne}from"./BARFPmgz.js";const le={trailing:!0};function oe(e,a=25,i={}){if(i={...le,...i},!Number.isFinite(a))throw new TypeError("Expected `wait` to be a finite number");let o,t,n=[],r,h;const m=(g,u)=>(r=ce(e,g,u),r.finally(()=>{if(r=null,i.trailing&&h&&!t){const v=m(g,h);return h=null,v}}),r);return function(...g){return r?(i.trailing&&(h=g),r):new Promise(u=>{const v=!t&&i.leading;clearTimeout(t),t=setTimeout(()=>{t=null;const y=i.leading?o:m(this,g);for(const D of n)D(y);n=[]},a),v?(o=m(this,g),u(o)):n.push(u)})}}async function ce(e,a,i){return await e.apply(a,i)}const ie=Symbol.for("nuxt:client-only"),ue=e=>e==="defer"||e===!1;function de(...e){var D;const a=typeof e[e.length-1]=="string"?e.pop():void 0;fe(e[0],e[1])&&e.unshift(a);let[i,o,t={}]=e;const n=N(()=>H(i));if(typeof n.value!="string")throw new TypeError("[nuxt] [useAsyncData] key must be a string.");if(typeof o!="function")throw new TypeError("[nuxt] [useAsyncData] handler must be a function.");const r=M();t.server??(t.server=!0),t.default??(t.default=_e),t.getCachedData??(t.getCachedData=G),t.lazy??(t.lazy=!1),t.immediate??(t.immediate=!0),t.deep??(t.deep=E.deep),t.dedupe??(t.dedupe="cancel"),t._functionName,r._asyncData[n.value];const h={cause:"initial",dedupe:t.dedupe};(D=r._asyncData[n.value])!=null&&D._init||(h.cachedData=t.getCachedData(n.value,r,{cause:"initial"}),r._asyncData[n.value]=L(r,n.value,o,t,h.cachedData));const m=r._asyncData[n.value];m._deps++;const g=()=>r._asyncData[n.value].execute(h),u=t.server!==!1&&r.payload.serverRendered;{let l=function(s){const f=r._asyncData[s];f!=null&&f._deps&&(f._deps--,f._deps===0&&(f==null||f._off()))};const _=X();if(_&&u&&t.immediate&&!_.sp&&(_.sp=[]),_&&!_._nuxtOnBeforeMountCbs){_._nuxtOnBeforeMountCbs=[];const s=_._nuxtOnBeforeMountCbs;Y(()=>{s.forEach(f=>{f()}),s.splice(0,s.length)}),Z(()=>s.splice(0,s.length))}const V=_&&(_._nuxtClientOnly||K(ie,!1));u&&r.isHydrating&&(m.error.value||m.data.value!=null)?(m.pending.value=!1,m.status.value=m.error.value?"error":"success"):_&&(!V&&r.payload.serverRendered&&r.isHydrating||t.lazy)&&t.immediate?_._nuxtOnBeforeMountCbs.push(g):t.immediate&&g();const x=W(),c=F([n,...t.watch||[]],([s],[f])=>{var d,R;if((s||f)&&s!==f){const P=((d=r._asyncData[f])==null?void 0:d.data.value)!==E.value;f&&l(f);const U={cause:"initial",dedupe:t.dedupe};(R=r._asyncData[s])!=null&&R._init||(U.cachedData=t.getCachedData(s,r,{cause:"initial"}),r._asyncData[s]=L(r,s,o,t,U.cachedData)),r._asyncData[s]._deps++,(t.immediate||P)&&r._asyncData[s].execute(U)}else m._execute({cause:"watch",dedupe:t.dedupe})},{flush:"sync"});x&&q(()=>{c(),l(n.value)})}const v={data:T(()=>{var l;return(l=r._asyncData[n.value])==null?void 0:l.data}),pending:T(()=>{var l;return(l=r._asyncData[n.value])==null?void 0:l.pending}),status:T(()=>{var l;return(l=r._asyncData[n.value])==null?void 0:l.status}),error:T(()=>{var l;return(l=r._asyncData[n.value])==null?void 0:l.error}),refresh:(...l)=>r._asyncData[n.value].execute(...l),execute:(...l)=>r._asyncData[n.value].execute(...l),clear:()=>$(r,n.value)},y=Promise.resolve(r._asyncDataPromises[n.value]).then(()=>v);return Object.assign(y,v),y}function T(e){return N({get(){var a;return(a=e())==null?void 0:a.value},set(a){const i=e();i&&(i.value=a)}})}function fe(e,a){return!(typeof e=="string"||typeof e=="object"&&e!==null||typeof e=="function"&&typeof a=="function")}function $(e,a){a in e.payload.data&&(e.payload.data[a]=void 0),a in e.payload._errors&&(e.payload._errors[a]=E.errorValue),e._asyncData[a]&&(e._asyncData[a].data.value=void 0,e._asyncData[a].error.value=E.errorValue,e._asyncData[a].pending.value=!1,e._asyncData[a].status.value="idle"),a in e._asyncDataPromises&&(e._asyncDataPromises[a]&&(e._asyncDataPromises[a].cancelled=!0),e._asyncDataPromises[a]=void 0)}function ve(e,a){const i={};for(const o of a)i[o]=e[o];return i}function L(e,a,i,o,t){var v;(v=e.payload._errors)[a]??(v[a]=E.errorValue);const n=o.getCachedData!==G,r=i,h=o.deep?B:I,m=t!=null,g=e.hook("app:data:refresh",async y=>{(!y||y.includes(a))&&await u.execute({cause:"refresh:hook"})}),u={data:h(m?t:o.default()),pending:I(!m),error:z(e.payload._errors,a),status:I("idle"),execute:(y={})=>{if(e._asyncDataPromises[a]){if(ue(y.dedupe??o.dedupe))return e._asyncDataPromises[a];e._asyncDataPromises[a].cancelled=!0}if(y.cause==="initial"||e.isHydrating){const l="cachedData"in y?y.cachedData:o.getCachedData(a,e,{cause:y.cause??"refresh:manual"});if(l!=null)return e.payload.data[a]=u.data.value=l,u.error.value=E.errorValue,u.status.value="success",Promise.resolve(l)}u.pending.value=!0,u.status.value="pending";const D=new Promise((l,_)=>{try{l(r(e))}catch(V){_(V)}}).then(async l=>{if(D.cancelled)return e._asyncDataPromises[a];let _=l;o.transform&&(_=await o.transform(l)),o.pick&&(_=ve(_,o.pick)),e.payload.data[a]=_,u.data.value=_,u.error.value=E.errorValue,u.status.value="success"}).catch(l=>{if(D.cancelled)return e._asyncDataPromises[a];u.error.value=Q(l),u.data.value=w(o.default()),u.status.value="error"}).finally(()=>{D.cancelled||(u.pending.value=!1,delete e._asyncDataPromises[a])});return e._asyncDataPromises[a]=D,e._asyncDataPromises[a]},_execute:oe((...y)=>u.execute(...y),0,{leading:!0}),_default:o.default,_deps:0,_init:!0,_hash:void 0,_off:()=>{var y;g(),(y=e._asyncData[a])!=null&&y._init&&(e._asyncData[a]._init=!1),n||J(()=>{var D;(D=e._asyncData[a])!=null&&D._init||($(e,a),u.execute=()=>Promise.resolve(),u.data.value=E.value)})}};return u}const _e=()=>E.value,G=(e,a,i)=>{if(a.isHydrating)return a.payload.data[e];if(i.cause!=="refresh:manual"&&i.cause!=="refresh:hook")return a.static.data[e]},ye={style:{display:"flex",gap:"8px","font-size":"24px",cursor:"pointer"}},me=["onClick"],he=j({__name:"RatingStars",props:{modelValue:{default:null},modelModifiers:{}},emits:["update:modelValue"],setup(e){const a=k(e,"modelValue");function i(o){a.value=o}return(o,t)=>(C(),p("div",ye,[(C(),p(A,null,ee(5,n=>b("span",{key:n,onClick:r=>i(n)},S((a.value??0)>=n?"★":"☆"),9,me)),64))]))}}),De={class:"grid",style:{gap:"16px"}},ge={key:0,class:"card"},be={key:1,class:"card"},pe={key:2,class:"card"},Ce={style:{display:"flex",gap:"16px"}},Pe=["src"],we={style:{flex:"1"}},Ee={style:{margin:"0 0 6px"}},Be={class:"muted"},Se={key:0},Ve={style:{"margin-top":"12px"}},Re={class:"card"},Ne={key:0,style:{"margin-top":"8px",color:"#86efac"}},Oe={key:1,class:"card",style:{"margin-top":"8px",color:"#fca5a5"}},xe=j({__name:"[id]",setup(e){const a=M().$api,i=ne(),o=B(""),t=B(null),n=B(null),r=B(!1),h=B(null);function m(){const c=i.query.dbId;return Array.isArray(c)?c[0]??null:c!=null?String(c):null}const g=N(m),u=N(()=>{const c=i.params.id,s=Array.isArray(c)?"/"+c.join("/"):String(c??"");try{return decodeURIComponent(s)}catch{return s}}),{data:v,pending:y,error:D}=de("bookDetail",async()=>{const c=i.query,s={openLibraryId:u.value,title:String(c.title??""),author:String(c.author??""),year:c.year!=null?Number(c.year):null,cover:c.cover?String(c.cover):null},f=m();if(f)try{const d=await a(`/books/my-library/${f}`,{method:"GET"});o.value=String((d==null?void 0:d.review)??""),t.value=(d==null?void 0:d.rating)??null,!s.cover&&(d!=null&&d.coverBase64)&&(s.cover=d.coverBase64)}catch(d){console.warn("No se pudo precargar desde la BD:",d)}return s}),l=N(()=>{var c;return n.value||((c=v.value)==null?void 0:c.cover)||null});function _(c){return new Promise((s,f)=>{const d=new FileReader;d.onload=()=>s(d.result),d.onerror=f,d.readAsDataURL(c)})}async function V(c){const s=c.target;s.files&&s.files[0]&&(n.value=await _(s.files[0]))}async function x(){var R;if(h.value=null,r.value=!1,!v.value)return;const c={openLibraryId:v.value.openLibraryId,title:v.value.title,author:v.value.author,year:v.value.year,...n.value?{coverBase64:n.value}:{},review:o.value,rating:t.value},s=!!g.value,f=s?`/books/my-library/${g.value}`:"/books/my-library",d=s?"PUT":"POST";console.log("[DEBUG] baseURL debe verse arriba en consola al arrancar el app"),console.log("[DEBUG] SAVE →",d,f,c);try{await a(f,{method:d,body:c}),r.value=!0}catch(P){console.error("[SAVE ERROR]",P),h.value=((R=P==null?void 0:P.data)==null?void 0:R.message)||(P==null?void 0:P.message)||"Error desconocido"}}return(c,s)=>{const f=he;return C(),p("div",De,[w(y)?(C(),p("div",ge,"Cargando…")):w(D)?(C(),p("div",be,"Error de precarga: "+S(w(D).message),1)):w(v)?(C(),p("div",pe,[b("div",Ce,[l.value?(C(),p("img",{key:0,src:l.value,alt:"portada",style:{width:"200px","aspect-ratio":"2/3","object-fit":"cover","border-radius":"10px"}},null,8,Pe)):O("",!0),b("div",we,[b("h2",Ee,S(w(v).title),1),b("small",Be,[ae(S(w(v).author)+" ",1),w(v).year?(C(),p("span",Se,"· "+S(w(v).year),1)):O("",!0)]),b("div",Ve,[b("input",{type:"file",onChange:V},null,32),s[2]||(s[2]=b("small",{class:"muted"}," Sube una portada (se guarda en base64)",-1))])])])])):O("",!0),b("div",Re,[s[3]||(s[3]=b("label",null,"Review",-1)),te(b("textarea",{class:"textarea","onUpdate:modelValue":s[0]||(s[0]=d=>o.value=d),maxlength:"500",rows:"6",placeholder:"Escribe una reseña (máx 500)"},null,512),[[re,o.value]]),s[4]||(s[4]=b("label",null,"Calificación",-1)),se(f,{modelValue:t.value,"onUpdate:modelValue":s[1]||(s[1]=d=>t.value=d)},null,8,["modelValue"]),b("div",{style:{display:"flex","justify-content":"flex-end","margin-top":"12px"}},[b("button",{class:"button",onClick:x},"Guardar en Mi Biblioteca")]),r.value?(C(),p("div",Ne,"Guardado correctamente ✔")):h.value?(C(),p("div",Oe," Error del servidor: "+S(h.value),1)):O("",!0)])])}}});export{xe as default};
